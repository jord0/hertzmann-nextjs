# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
npm run dev       # Start dev server (Turbopack)
npm run build     # Next.js build (no prebuild step; no DB required at build time)
npm run lint      # ESLint
```

There are no tests. The build no longer requires a live DB connection — browse data is fetched at request time via `unstable_cache`.

## Architecture

### Data pipeline

Data flows in two distinct modes:

**Browse page (`/photographs`):** Server Component. Calls `getBrowseData()` from `lib/browse-data.ts`, which uses `unstable_cache` (tag: `browse-data`) to cache the photographer list and keyword list. The cache is invalidated by admin actions via `revalidateTag('browse-data')`. `data.json` and `scripts/generate-data.ts` are retired.

**At request time:** Individual photographer, subject, and photo detail pages query the Railway MySQL database directly via `lib/db.ts`. Each call opens a new connection, runs the query, and closes it (no pooling).

This means:
- `/photographs` (browse page) — async Server Component, cached DB query via `unstable_cache`
- `/photographs/photographer/[slug]` — SSG via `generateStaticParams`, DB query at build + runtime fallback
- `/photographs/subject/[keyword]` — same pattern
- `/photographs/photo/[id]` — dynamically rendered (uses `searchParams`), DB queries every request

### Database schema

**`photographers` table**
| column | type | notes |
|---|---|---|
| `id` | int PK | |
| `firstName` | varchar | |
| `lastName` | varchar | |
| `years` | varchar | may contain HTML entities (`&ndash;`) |
| `country` | varchar | |
| `enabled` | tinyint | 1 = visible on site |

**`photos` table**
| column | type | notes |
|---|---|---|
| `id` | int PK | |
| `photographerId` | int FK | references `photographers.id` |
| `title` | varchar | |
| `medium` | varchar | |
| `date` | varchar | |
| `width` | varchar | |
| `height` | varchar | |
| `price` | varchar | |
| `description` | text | |
| `provenance` | text | |
| `inventoryNumber` | varchar | |
| `keywords` | varchar | pipe-delimited with leading/trailing pipes: `\|kw1\|kw2\|` |
| `enabled` | tinyint | 1 = visible on site |

### Admin panel

Located at `/admin/*`. Protected by `middleware.ts` using `iron-session`.

**Authentication:**
- Session managed by `iron-session` (`lib/session.ts`)
- Password stored as a bcrypt hash in `ADMIN_PASSWORD_HASH` env var
- Session secret in `ADMIN_SESSION_SECRET` env var (32+ char string)
- Login: `POST /api/admin/login` — bcrypt compare, set session cookie
- Logout: `POST /api/admin/logout` — clear session, redirect to login
- Middleware protects all `/admin/*` except `/admin/login`

**Revalidation rules:**

| Admin action | Cache busted |
|---|---|
| Add/toggle photographer | `revalidateTag('browse-data')` |
| Edit photographer name | + `revalidatePath('/photographs/photographer/[old-slug]')` |
| Add/toggle photo | `revalidateTag('browse-data')` + `revalidatePath('/photographs/photographer/[slug]')` |
| Edit photo | Same as above |
| New keyword added | `revalidateTag('browse-data')` (new subject page renders on-demand) |

**Required env vars:**
```
ADMIN_PASSWORD_HASH=   # bcrypt hash, generate with: node -e "require('bcryptjs').hash('yourpassword',10).then(console.log)"
ADMIN_SESSION_SECRET=  # 32+ char random string
```

### Image upload (Cloudflare R2)

Images are uploaded to Cloudflare R2 via the admin panel (`/api/admin/upload`).

- Package: `@aws-sdk/client-s3` (R2 is S3-compatible)
- Upload/delete logic: `lib/r2.ts` — `uploadPhoto(photographerId, photoId, buffer)` and `deletePhoto(photographerId, photoId)`
- API route: `app/api/admin/upload/route.ts` — verifies session, parses `formData`, calls `uploadPhoto()`
- Files stored in R2 as `photos/{photographerId}_{photoId}.jpg`
- Public URL constructed by `lib/photo-url.ts` using `NEXT_PUBLIC_PHOTOS_BASE_URL` env var

**Required env vars:**
```
CF_ACCOUNT_ID=           # Cloudflare account ID
R2_ACCESS_KEY_ID=        # R2 API token access key
R2_SECRET_ACCESS_KEY=    # R2 API token secret
R2_BUCKET_NAME=          # R2 bucket name
NEXT_PUBLIC_PHOTOS_BASE_URL=  # Public bucket URL, e.g. https://pub-xxxx.r2.dev/photos (no trailing slash)
```

**Local development:** omit `NEXT_PUBLIC_PHOTOS_BASE_URL` to fall back to `/photos` (served from `public/photos/`).

### Photo images

Images are served from Cloudflare R2 in production. The URL is generated by `lib/photo-url.ts` (`photoImageUrl(photographerId, photoId)`) using the `NEXT_PUBLIC_PHOTOS_BASE_URL` env var. In local development, falls back to `public/photos/`. Missing images fail silently; `enabled = 1` in the DB is the gating condition, not filesystem presence.

### Contextual navigation on photo detail

Photo detail pages use nested routes to carry context, enabling back links and prev/next navigation within a set:
- `/photographs/photographer/[slug]/[id]` — navigates within that photographer's photos
- `/photographs/subject/[keyword]/[id]` — navigates within that subject's photos
- `/photographs/photo/[id]` — fallback with no prev/next context (e.g. direct links)

The shared UI lives in `app/photographs/_components/PhotoDetail.tsx`. Each nested route computes its own `NavContext` (backHref, backLabel, prevHref, nextHref) and passes it to `PhotoDetail`.

### Styling

All styling uses **CSS Modules** (`.module.css`) colocated with each component or page. Tailwind is installed but not used for component styling — only for the global CSS reset via `@import "tailwindcss"` in `globals.css`. Do not introduce Tailwind utility classes on components.

**Rules:**
- CSS Modules for all static styles — class names in camelCase (`styles.heroSection`)
- Conditional classes: `className={active ? styles.tabActive : styles.tab}`
- Inline `style={{}}` only for truly runtime-dynamic values (e.g. a dot color driven by a `hasEnabledPhotos` boolean)
- No `<style>` tags in components — use `@media` queries inside the `.module.css` file instead

### Design tokens

Design token values are exposed as **CSS custom properties** in `app/globals.css` (`:root` block) and as a TypeScript object in `lib/design-tokens.ts`. The two must stay in sync.

**CSS custom properties** (use in `.module.css` files):
```css
var(--color-gold)        /* #F0B23C — accent, rules, highlights */
var(--color-dark)        /* #1a1a1a — CTA section background only */
var(--color-foreground)  /* #2a2a2a — primary text */
var(--color-muted)       /* #666666 — secondary text */
var(--color-bg)          /* #ffffff */
var(--color-bg-warm)     /* #faf8f4 — caption bars, warm backgrounds */
var(--color-border-warm) /* #e8e0d0 */
var(--font-weight-light)    /* 300 */
var(--font-weight-medium)   /* 500 */
var(--font-weight-semibold) /* 600 */
var(--font-inter)        /* set by next/font on <body> */
var(--font-cormorant)    /* set by next/font on <body> */
```

**TypeScript tokens** (use in `.tsx` files for runtime-dynamic values only):
```ts
import { tokens } from '@/lib/design-tokens';
// e.g. style={{ color: p.hasEnabledPhotos ? '#6b9e6b' : tokens.color.gold }}
```

**Typography scale:**
- Display / section headings: Cormorant 600, 2.75rem+
- Sub-headings: Cormorant 600, 1.5rem
- Body: Inter 300, 1rem / 1.8 line-height
- Caps labels / nav: Inter 500, 0.75–0.8rem, `0.08–0.12em` letter-spacing, uppercase

**Section anatomy:**
- Content sections: `padding: 5rem 2.5rem`, `max-width: 1100px`, `margin: 0 auto`
- Full-bleed colored bands: no max-width, `width: 100%`

**Design reference:** `lib/design-tokens.ts` and `app/globals.css` `:root` vars are the authoritative source of design tokens.

### `useSearchParams` requires Suspense

Any client component that calls `useSearchParams()` must be wrapped in a `<Suspense>` boundary. The pattern used here is a thin exported wrapper that renders the real component inside `<Suspense>` (see `app/photographs/page.tsx`).

### HTML entities in DB data

Photographer `years` and other fields can contain HTML entities (`&ndash;`, `&rsquo;`, etc.) from the legacy system. Always pass these through `decodeHtmlEntities()` from `lib/htmlDecode.ts` before rendering.

### Photographer slugs

Slugs are not stored in the database — they are generated on the fly from `firstName` and `lastName`. The generation logic must stay consistent across all files that use it:
```ts
`${firstName || ''}-${lastName}`.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '').replace(/^-+|-+$/g, '')
```

### Deployment

Deployed on Vercel, connected to `github.com/jord0/hertzmann-nextjs`. Pushing to `main` triggers a production deployment. The build does **not** require a DB connection — browse data is fetched and cached at runtime. The Railway DB must be reachable from Vercel's runtime environment (not build environment) for the site to function.
